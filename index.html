<!DOCTYPE html>
<html lang="en">
<head>
	    <!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<title>Dapp</title>
		<script src="libs/nebPay.js"></script>
		<script src="libs/jquery-3.1.1.min.js"></script>
		<link rel="stylesheet" href="site.css">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
</head>

<body>
	<div class="container">
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<a class="navbar-brand" href="#">Questions - Daaps NEB</a>
			<div class="collapse navbar-collapse" id="navbarNav">
				<ul class="navbar-nav">
				</ul>
			</div>
			<button class="btn btn-sm btn-primary" type="button">New Question</button> &nbsp;
			<button class="btn btn-sm btn-secondary" type="button">My Questions</button>
		</nav>	
		
		<br>
		<br>
		<br>

				<!--<div class="row">
					<div class="col-4">
						<div class="question-box">
							<h4>¿Quien ganará el mundial?</h4>
							<div class="radio">
								<label><input type="radio" value= "Brazil" name="vote">Brazil</label>
							</div>
							<div class="radio">
								<label><input type="radio" value= "Argentina" name="vote">Argentina</label>
							</div>
							<div class="radio">
								<label><input type="radio" value= "France" name="vote" >France</label>
							</div>
							<div class="radio">
								<label><input type="radio" value= "Germany" name="vote" >Germany</label>
								</div>
								<div class="radio">
								<label><input type="radio" value= "Portugal" name="vote" >Portugal</label>
								</div>
							<button type="button" class="btn btn-primary btn-vote">Vote</button>
						</div>
					</div>
				</div> -->
				
			<div class="row questions">

			</div>
	</div>

<script>

	var contract_address = "n1zsH1HnWbQPw7rLRxc9CRw5gjT6qfzyt7P"
	var txhash = null;
	var NebPay = require("nebpay");
	var nebPay = new NebPay();

	$( document ).ready(function() {
		if(typeof(webExtensionWallet) === "undefined"){
		alert ("Extension wallet is not installed, please install it first.")
		}
		$('#btnGetVote').click(GetVote);

		GetQuestion();

	}); //End document.ready

	function SubmitVote(){
		var question_id = this.value;
		var parentId = $(this).parent().attr('id');
		var answer = $('#' + parentId + ' ' + 'input[name=vote]:checked').val(); 
		if(answer != undefined){
			
		}
		else{
			alert("You must select an answer")
		}
	}

	function GetQuestion(){
		nebPay.simulateCall(contract_address,0,"getQuestion",null,{
			qrcode: {
				showQRCode: false,
				completeTip: undefined, 
				cancelTip: undefined,
				container: undefined
		 	},
			callback: "https://pay.nebulas.io/api/pay",
			listener: ShowQuestion	
		});
	}

	function ShowQuestion(resp){

		var question = JSON.parse(resp.result);

		question.forEach(element => {
			console.log(element);
			
			var idSelector = "item-" + element.question_id;

			//Crear columna
			$('.questions').append(function(){				
				return `<div class="col-4"><form id="${idSelector}"></form></div>`
			});

			//Agregar titulo
			$('#' + idSelector).append(function(){
				return "<h5>" + element.title + "</h5>";
			});

			//Agregar Respuestas  //<label><input type="radio" value= "Brazil" name="vote">Brazil</label>
 			element.answers.forEach(a => {
				 $('#' + idSelector).append(function(){
					 var count_votes = `<i><small>(${a.count_votes} votes)</small></i>`
					 return `<div class="radio"><label><input type="radio" value="${a.item}" name="vote">${a.item} ${count_votes}</label></div>`
				 });
			});

			//Agregar Boton
			$('#' + idSelector).append(function(){
				return `<button type="button" class="btn btn-primary btn-vote" value="${element.question_id}">Vote Now</button>`
			})
		});

		//Asignar evento al boton
		$('.btn-vote').on("click", SubmitVote);
	}

	$('#voteSubmit').submit(function(vote){
		var vote = $(':radio[name=vote]:checked').val();
		nebPay.call(contract_address,0,"submitVote",JSON.stringify([vote]),{
			qrcode: {
				showQRCode: false,
				completeTip: undefined, 
				cancelTip: undefined,
				container: undefined
		 	},
			callback: NebPay.config.testnetUrl,
			listener: VoteSubmitted
		});		
		event.preventDefault();
	});

	function VoteSubmitted(resp){
		txhash = resp.txhash;
		console.log("txhash => " + txhash);
	}
	function GetVote(){
		nebPay.simulateCall(contract_address,0,"getVote",JSON.stringify([txhash]),{
			callback: NebPay.config.testnetUrl,
			listener: function(resp){
				var response = JSON.parse(resp.result);
				if(response){
					$('#myVote').text(reseponse.vote);
				}
				else{
					$('#myVote').text("null");
				}
			}
		});
		event.preventDefault();
	}

</script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
</body>
</html>